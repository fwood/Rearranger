% !TEX root = main.tex
\section{Acoustic Model and Inference by Sampling}
\label{sec:model}

The generative model for a spectrogram is as follows.  Every note that an instrument plays has a fixed voice $V_{fk}$ at frequency $f$, where the index $k$ is over both instruments and notes the instrument plays.  Within each beat $b$, if that instrument is playing that note, then $S_{kb} = 1$, otherwise $S_{kb} = 0$.  There is also a loudness associated with any note being played, $D_{kb}$, so the spectrogram at frequency $f$ and beat $b$ is given by 

\begin{equation}
A_{fb} = \sum_{k} V_{fk} S_{kb} D_{kb}
\end{equation}

However, not every note sounds exactly the same every time it is played, and if we are working with a source not generated by the instruments for which we have voices, some distortion must be accounted for.  We account for this by adding Poisson noise, and saying the spectrogram is generated as

\begin{equation}
A_{fb} \sim \mathrm{Poisson}(\sum_k V_{fk} S_{kb} D_{kb} )
\end{equation}

While we place a Gamma($\alpha,\alpha$) prior over $D_{kb}$ (in units of rate, not scale) and an MRF prior on $S_{kb}$.  We sample $S_{kb}$ and $D_{kb}$ by Gibbs sampling.  To sample $S$, for each instrument in one beat we consider all 49 possible notes (including rests).  Let $S_{ib} = k$ mean that the instrument $i$ in beat $b$ is playing note $k$ while all other notes for instrument $i$ are off.  Then we evaluate $p(A|S_{ib}=k,S_{-ib},D)p(S_{ib}=k|S_{-ib})$ for all possible $k$ and sample from the conditional probability, given the current values of $D$.

Sampling $D_{kb}$ is trivial if $S_{kb} = 0$, just sample from the prior.  Otherwise, we take advantage of the divisibility property of Poisson-distributed random variables to construct an auxilliary-variable sampler.  Suppose that $A_{fb}$ is the sum of Poisson-distributed random variables $\~{A}^k_{fb}$, each with intensity $V_{fk} S_{kb} D_{kb}$, and define $Z_{kb} = \sum_f \~{A}^k_{fb}$.  Then $D_{kb}|Z_{kb} \sim$ Gamma($\alpha + Z_{kb},\alpha + S_{kb} \sum_f V_{fk}$).  To sample $Z$, since we know $\sum_k \~{A}^k_{fb} = A_{fb}$, so we take $A_{fb}$ samples from a $k$-valued multinomial with probabilities proportional to $V_{fk} S_{kb} D_{kb}$ and sum over $f$ to sample $Z_{kb}|D_{kb},A_{fb}$.  Iteratively sampling these two variables gives a Gibbs sampler for $D|S,A,V$.